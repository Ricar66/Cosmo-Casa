<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Module Selection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="conteudo-centralizado selecao-modulos">
    <header class="brand-header">
        <img class="brand-logo" src="{{ url_for('static', filename='imagens/Group 3.png') }}" alt="Cosmo Casa logo">
    </header>
    <div class="container-grande toolbar-row mt-8 mb-8">
        {% if not session.get('aluno_id') %}
            <a href="{{ url_for('missao.montagem_transporte', destino=destino, codigo_sala=codigo_sala) }}" class="botao">Back</a>
        {% endif %}
        <a href="{{ url_for('aluno.aluno_entrar') }}" class="botao">Finish Game</a>
        <a href="{{ url_for('missao.ranking_rodada') }}" class="botao">View Ranking</a>
    </div>
    {% if session.get('erro_modulos') %}
    <div class="container-grande mt-8">
        <div class="alerta" role="alert">
            {{ session.get('erro_modulos') }}
        </div>
    </div>
    {% endif %}
<form class="container-grande" action="{{ url_for('missao.viagem', destino=destino, nave_id=nave_id, codigo_sala=codigo_sala) }}" method="POST">
        
        <h2>Cargo Assembly</h2>
        {% set destino_en_map = {'lua': 'Moon', 'marte': 'Mars', 'exoplaneta': 'Exoplanet'} %}
        {% set destino_display = destino_en_map.get(destino.lower(), destino.capitalize()) %}
        <div class="info-nave">
            <span>Mission: <strong>{{ destino_display }}</strong></span>
            <span>Spacecraft: <strong>{{ nave.nome }}</strong></span>
        </div>

        <div class="sumario-carga">
            <h3>Mission Summary</h3>
            <p>
                Total Selected Mass: 
                <span id="massa-total">0</span> kg / 
                <span id="capacidade-carga">{{ (nave.capacidade_carga * 1000) | int }}</span> kg
            </p>
            <div class="barra-progresso-container">
                <div id="barra-progresso" class="barra-progresso"></div>
            </div>
            
            <!-- Performance information -->
            <div id="info-performance" class="info-performance mt-16">
                <h4>Mission Analysis</h4>
                <p>
                    <strong>Maximum Capacity:</strong> 
                    <span id="capacidade-maxima">Calculating...</span>
                </p>
                <p>
                    <strong>Estimated Duration:</strong> 
                    <span id="duracao-missao">Calculating...</span>
                </p>
                <p id="explicacao-duracao">
                    Base duration calculated for mission {{ destino_display }}
                </p>
            </div>
            
            <!-- Survival information only for lunar missions -->
            {% if destino.lower() == 'lua' %}
            <div id="info-sobrevivencia" class="info-sobrevivencia mt-16">
                <h4>ðŸ§­ Lunar Survival Guidelines</h4>
                <ul class="list-clean">
                    <li>Keep life support systems prioritized</li>
                    <li>Verify sealing of habitat modules</li>
                    <li>Monitor oxygen levels and internal pressure</li>
                    <li>Conserve energy during periods of low sunlight</li>
                    <li>Maintain emergency stock for 48 hours</li>
                </ul>
            </div>
            {% endif %}
        </div>

        <h3>Available Modules</h3>
        <div class="modulos-controls">
            <input type="text" id="filtro-modulos" placeholder="Filter modules..." aria-label="Filter modules">
        </div>
        {% set ordem_modulos = [
            'suporte_vida','habitacional','alimentacao','medico','exercicios','pesquisa',
            'armazenamento','sanitario','blindagem','inflavel','airlock','estrutural',
            'lazer','robotico','hidroponia','controle','multifuncional','impressao3d'
        ] %}
        <div id="container-modulos" class="modulos-container cards-scroll-inner">
            {% for id in ordem_modulos %}
            {% set modulo = modulos.get(id) %}
            {% if modulo %}
            <div class="modulo-card compacto" data-id="{{ id }}" data-massa="{{ modulo.massa }}" data-energia="{{ modulo.energia }}" data-agua="{{ modulo.agua }}" data-tooltip="{{ modulo.obs }}">
                <div class="modulo-imagem-container">
                    <img src="{{ url_for('static', filename='imagens/' + modulo.imagem) }}" alt="{{ modulo.nome }}" onerror="this.onerror=null;this.src='{{ url_for('static', filename='imagens/Multifuncional.svg') }}'">
                </div>
                <div class="modulo-info">
                    <h4 id="modulo-titulo-{{ id }}">{{ modulo.nome }}</h4>
                    </div>
                    <div class = 'modulos-stats'>
                    <p><strong>Mass:</strong> {{ modulo.massa }} kg</p>
                    <p><strong>Energy:</strong> {{ modulo.energia }} kWh/day</p>
                    <p><strong>Water:</strong> {{ modulo.agua }} L/day</p>
                    </div>
                
                <div class="controles-modulo">
                    <button type="button" class="botao-adicionar" title="Add module">+</button>
                    <button type="button" class="botao-modulo">Add</button>
                    <button type="button" class="botao-remover" title="Remove module">âˆ’</button>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        
        <div id="modulos-selecionados-hidden"></div>
        <button type="submit" class="botao" id="botao-lancar">Launch Mission</button>
        
    </form>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
    // Block: prevent launch without at least one selected module
    document.addEventListener('DOMContentLoaded', function(){
        const form = document.querySelector('form.container-grande[action*="/viagem/"]');
        const hidden = document.getElementById('modulos-selecionados-hidden');
        const botao = document.getElementById('botao-lancar');
        function enforce(){
            const count = hidden.querySelectorAll('input[name="modulos_selecionados"]').length;
            if (count === 0) {
                botao.disabled = true;
                botao.style.opacity = '0.5';
            } else if (!botao.disabled) {
                botao.style.opacity = '1';
            } else {
                // reabilita somente se nÃ£o houver outras restriÃ§Ãµes (capacidade etc. tratadas no script.js)
                botao.disabled = false;
                botao.style.opacity = '1';
            }
        }
        enforce();
        if (form) {
            form.addEventListener('submit', function(e){
                const count = hidden.querySelectorAll('input[name="modulos_selecionados"]').length;
                if (count === 0) {
                    e.preventDefault();
                    alert('Select at least one module to launch the mission.');
                }
            });
        }
        const observer = new MutationObserver(enforce);
        observer.observe(hidden, {childList:true});
    });
    </script>
    
</body>
</html>
