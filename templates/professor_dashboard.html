<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professor Dashboard - Cosmo Home</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
</head>
<body class="conteudo-centralizado">
    <header class="brand-header">
        <img class="brand-logo" src="{{ url_for('static', filename='imagens/Group 3.png') }}" alt="Cosmo Casa logo">
    </header>
    <!-- Barra separada para a√ß√µes no canto superior direito -->
    <div class="topbar-actions-row">
        <div class="topbar-actions">
            <a href="{{ url_for('professor.professor_reset_password', next=request.path) }}" class="action-btn">Change password</a>
            <a href="{{ url_for('professor.professor_logout') }}" class="action-btn danger">Logout</a>
        </div>
    </div>

    <!-- Barra de boas-vindas isolada -->
    <div class="topbar">
        <div class="user">Welcome, {{ professor_nome or 'Professor' }}</div>
    </div>
    
    <main class="dashboard-container">
        <div class="page-grid">
            <section class="actions-column">
                <div class="dashboard-header">
                    <h2>Professor Dashboard</h2>
                </div>
                
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert-banner {{ 'success' if category == 'success' else 'warning' if category == 'warning' else 'danger' if category == 'error' else '' }}">
                                <div class="msg">{{ message }}</div>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                {% if must_change_admin %}
                <div class="alert-banner">
                    <div class="msg">Your default password is still active. For security, please change it.</div>
                    <a href="{{ url_for('professor.professor_reset_password', next=request.path) }}" class="action-btn">Change password</a>
                </div>
                {% endif %}
                <!-- Cards de A√ß√µes Principais -->
                <div class="dashboard-grid">
            <!-- Card de Ranking -->
            <div class="dashboard-card">
                <h4>Score Ranking</h4>
                {% if ranking %}
                <div class="ranking-list">
                    {% for item in ranking %}
                    <div class="ranking-item">
                        <span><strong>{{ loop.index }}. {{ item.nome }}</strong>: {{ item.total }} points ‚Äî Completed: {{ item.concluidos }} ‚Äî Attempts: {{ item.tentativas }}</span>
                        <form method="POST" action="{{ url_for('professor.professor_excluir_aluno_ranking') }}">
                            <input type="hidden" name="aluno_id" value="{{ item.id }}" />
                            <button type="submit" class="action-btn danger">üóëÔ∏è</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state empty-state--compact">
                    <p>No scores recorded yet.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Card de Cria√ß√£o de Sala -->
            <div class="dashboard-card">
                <h4>Create New Room</h4>
                <form method="POST" action="{{ url_for('professor.professor_criar_sala') }}" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="nome_sala" class="form-label">Room Name</label>
                        <input type="text" id="nome_sala" name="nome_sala" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="lista_alunos" class="form-label">Student List (.txt)</label>
                        <input type="file" id="lista_alunos" name="lista_alunos" accept=".txt" class="form-input" required>
                        <small>One student per line</small>
                    </div>
                    
                    <button type="submit" class="action-btn success btn-block">
                        ‚ú® Create Room
                    </button>
                </form>
            </div>
                </div>
            </section>
        
        <!-- Se√ß√£o de Salas -->
        <section class="salas-column">
        <h3 class="section-title">My Rooms</h3>
        
        {% if salas %}
        <div class="salas-container">
            {% for sala in salas %}
            <div class="sala-card">
                <div class="sala-header">
                    <h4 class="sala-title">{{ sala.nome_sala }}</h4>
                </div>
                
                <div class="sala-code">
                    <span><strong>Code:</strong> {{ sala.codigo }}</span>
                    <button class="action-btn ml-auto btn-compact" onclick="copiarCodigo('{{ sala.codigo }}')">
                        üìã Copy
                    </button>
                </div>
                
                <div class="sala-info">
                    <div class="sala-info-item">
                        <strong>Destination:</strong> {{ sala.destino }}
                    </div>
                    <div class="sala-info-item">
                        <strong>Spacecraft:</strong> {{ sala.nave_id }}
                    </div>
                    <div class="sala-info-item">
                        <strong>Students:</strong> {{ sala.aluno_count }}
                    </div>
                    <div class="sala-info-item">
                        <strong>Created:</strong> {{ sala.data_criacao }}
                    </div>
                </div>
                
                <div class="sala-actions">
                    <a href="{{ url_for('professor.professor_sala_detalhes', codigo_sala=sala.codigo) }}" class="action-btn info">
                        üëÅÔ∏è View details
                    </a>
                    <a href="{{ url_for('tela_selecao', codigo_sala=sala.codigo) }}" class="action-btn success">
                        ‚úö Create challenge
                    </a>
                    <form method="POST" action="{{ url_for('professor.professor_sala_fechar') }}" class="no-margin">
                        <input type="hidden" name="codigo_sala" value="{{ sala.codigo }}" />
                        <button type="submit" class="action-btn danger">
                            üîí Close room
                        </button>
                    </form>
                </div>
                
                {% if sala.desafios and sala.desafios|length > 0 %}
                <div class="desafios-container">
                    <h5 class="desafios-title">Room Challenges</h5>
                    
                    {% for d in sala.desafios %}
                    <div class="desafio-item">
                        <form method="POST" action="{{ url_for('professor.professor_editar_desafio') }}" class="desafio-form">
                            <div class="desafio-fields-grid">
                                <input type="hidden" name="codigo_sala" value="{{ sala.codigo }}" />
                                <input type="hidden" name="desafio_index" value="{{ loop.index0 }}" />
                                <input type="text" name="titulo" value="{{ d.titulo if d.titulo else ('Desafio ' ~ loop.index) }}" class="form-input">
                                <input type="text" name="descricao" value="{{ d.descricao if d.descricao else d }}" class="form-input">
                            </div>
                            
                            <div class="desafio-buttons">
                                <button type="submit" class="action-btn success btn-compact">üíæ</button>
                                
                                <button type="button" class="action-btn btn-compact" 
                                        onclick="document.getElementById('select-form-{{ sala.codigo }}-{{ loop.index0 }}').submit();">
                                    ‚úì
                                </button>
                                
                                <button type="button" class="action-btn danger btn-compact"
                                        onclick="document.getElementById('delete-form-{{ sala.codigo }}-{{ loop.index0 }}').submit();">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </form>
                        
                        <form id="select-form-{{ sala.codigo }}-{{ loop.index0 }}" 
                              method="POST" 
                              action="{{ url_for('professor.professor_selecionar_desafio') }}" 
                              class="is-hidden">
                            <input type="hidden" name="codigo_sala" value="{{ sala.codigo }}" />
                            <input type="hidden" name="desafio_index" value="{{ loop.index0 }}" />
                        </form>
                        
                        <form id="delete-form-{{ sala.codigo }}-{{ loop.index0 }}" 
                              method="POST" 
                              action="{{ url_for('professor.professor_excluir_desafio') }}" 
                              class="is-hidden">
                            <input type="hidden" name="codigo_sala" value="{{ sala.codigo }}" />
                            <input type="hidden" name="desafio_index" value="{{ loop.index0 }}" />
                        </form>
                    </div>
                    {% endfor %}
                    
                    {% if sala.desafio_selecionado_index is not none %}
                    <div class="desafio-selecionado">
                        <strong>Selected Challenge:</strong>
                        <div class="mt-8">
                            {% set dsel = sala.desafios[sala.desafio_selecionado_index] %}
                            {% if dsel.descricao %}
                                {{ dsel.descricao }}
                            {% else %}
                                {{ dsel }}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">      
            <h2 class="empty-text">No rooms created yet</h2>
            <p>Create your first virtual room to begin the space journey with your students!</p>
        </div>
        {% endif %}
        </section>

        
        </div>
    </main>
    
    <script>
        function copiarCodigo(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                alert('Code copied: ' + codigo);
            }).catch(err => {
                alert('Error copying code: ' + err);
            });
        }

        // Toggle de desafios dentro de cada sala-card
        document.addEventListener('DOMContentLoaded', function() {
            // Suporte a bot√µes dedicados (se existirem) com classe .toggle-desafios
            document.querySelectorAll('.toggle-desafios').forEach(button => {
                button.addEventListener('click', function(evt) {
                    evt.preventDefault();
                    const salaCard = this.closest('.sala-card');
                    if (salaCard) {
                        salaCard.classList.toggle('is-open');
                    }
                });
            });

            // Permitir colapsar/expandir ao clicar no t√≠tulo dos desafios
            document.querySelectorAll('.desafios-title').forEach(title => {
                title.addEventListener('click', function() {
                    const salaCard = this.closest('.sala-card');
                    if (salaCard) {
                        salaCard.classList.toggle('is-open');
                    }
                });
            });
        });
    </script>
    <script src="{{ url_for('static', filename='js/ws.js') }}"></script>
</body>
</html>
